<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Sensor Data</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        #graph {
            width: 90%;
            margin: auto;
            height: 500px;
        }
    </style>
</head>
<body>
    <h1>Real-Time Sensor Data</h1>
    <div id="graph"></div>

    <script>
        let utcTimestamps = [];
        let pm25Data = [];
        let temperatureData = [];

        async function fetchData() {
            try {
                const response = await fetch("http://192.168.4.1/latest");  // Fetch latest data from the server
                const textData = await response.text();

                // Assuming the file content is in CSV format
                const lines = textData.trim().split("\n");
                const latestLine = lines[lines.length - 1];  // Get the last line
                const fields = latestLine.split(",");  // Split by comma

                const utcTimestamp = fields[1];  // Assuming UTC timestamp is the second column
                const pm25 = parseFloat(fields[8]);  // Assuming PM2.5 is the 9th column
                const temperature = parseFloat(fields[5]);  // Assuming temperature is the 6th column

                const timePart = utcTimestamp.split("T")[1];  // Get the time part of the timestamp

                utcTimestamps.push(timePart);
                pm25Data.push(pm25);
                temperatureData.push(temperature);

                // Keep the latest 50 data points for smooth plotting
                if (utcTimestamps.length > 50) {
                    utcTimestamps.shift();
                    pm25Data.shift();
                    temperatureData.shift();
                }

                updatePlot();  // Update the plot with the new data
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        function updatePlot() {
            const tracePM25 = {
                x: utcTimestamps,
                y: pm25Data,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'PM2.5',
                marker: { color: 'blue' },
                yaxis: 'y1'
            };

            const traceTemperature = {
                x: utcTimestamps,
                y: temperatureData,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Temperature',
                marker: { color: 'red' },
                yaxis: 'y2'
            };

            const layout = {
                title: 'Real-Time Sensor Data',
                xaxis: {
                    title: 'UTC Time',
                    type: 'category'  // Ensures time values are treated as categories
                },
                yaxis: {
                    title: 'PM2.5 (µg/m³)',
                    titlefont: { color: 'blue' },
                    tickfont: { color: 'blue' }
                },
                yaxis2: {
                    title: 'Temperature (°C)',
                    titlefont: { color: 'red' },
                    tickfont: { color: 'red' },
                    overlaying: 'y',
                    side: 'right'
                },
                showlegend: true
            };

            Plotly.newPlot('graph', [tracePM25, traceTemperature], layout);
        }

        setInterval(fetchData, 30000);  // Fetch data every 30 seconds
        fetchData();  // Initial fetch when the page loads
    </script>
</body>
</html>
